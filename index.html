<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=PT+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <title>Генератор VM-шаблонов</title>
  <style>
    :root{
      --lighter-blue: #D8E1F6;
      --light-blue: #4D83FA;
      --blue: #1D5DEB;
    }
    *{
      font-family: "PT Sans", sans-serif;
    }
    body { 
      font-family: 'Inter', sans-serif; margin: 0; padding: 10px; background: #FFFFFF;
      display: flex;
   }
    .elems{
      width: 20%;
      padding-top: 40px;
      border-bottom: 1px solid var(--lighter-blue);
      border-left: 1px solid var(--lighter-blue);
      border-top: 1px solid var(--lighter-blue);
      border-bottom-left-radius: 12px;
      border-top-left-radius: 12px;
    }
    .container {
      border: 1px solid var(--lighter-blue);
      width: 80%;
      padding: 0px 48px 48px 48px;
      border-bottom-right-radius: 12px;
      border-top-right-radius: 12px;
    }
    .container>h1 {
      font-size: 3rem;
      font-weight: 100;
      color: #1E293B;
      text-align: center;
      margin: 40px 0px; /* Increased spacing */
    }

    .input-group {
      margin-bottom: 24px; /* Increased spacing */
    }

    label {
      display: block;
      font-size: 1rem;
      font-weight: 500;
      color: #334155;
      margin-bottom: 8px;
    }

    input[type="text"],
    .custom-file-upload {
    border: 2px solid var(--blue);
    height: 40px;
    width: 280px;
      padding: 12px;
      border-radius: 11px;
      font-size: 16px;
      color: #4B5563;
      outline: none;
    }
    input[type="file"] {
  display: none;
}
input[type="text"]{
  height: 20px; width: 500px;
}
input[type="text"]::placeholder{
  color: var(--blue);
  opacity: .5;
}

.custom-file-upload {
  cursor: pointer;
  font-size: 20px !important;
  width: 185px !important;
      text-align: center;
    line-height: 40px;
    color: var(--blue);
}
.active-article{
  background-color: var(--lighter-blue);
}
article{
  height: 70px;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  margin-bottom: 10px;
  padding-left: 10px;
}
article:nth-of-type(2){
  margin-left: 5px;
}
/* img{
  margin-right: 20px;
  width:50px;
  height:50px;
} */

    input[type="text"]:focus,
    input[type="file"]:focus {
      box-shadow: 0px 0px 0px 2px var(--blue);
    }

    input[type="file"] {
      margin-top: 4px;
    }

    button {
      padding: 20px 70px;
      margin-left: 75%;
      background: #2563EB;
      color: white;
      border: none;
      border-radius: 11px;
      cursor: pointer;
      font-size: 25px;
      transition: background-color 0.2s ease;
    }

    button:disabled {
      background: #b4c4e0;
      cursor: not-allowed;
    }

    button:hover:not(:disabled) {
      background: #1E40AF;
    }

    pre {
      width: 90%;
      height: 500px;
      overflow-y: scroll;
      background: #F3F4F6;
      padding: 24px;
      border-radius: 11px;
      display: none;
      overflow-x: scroll;
      white-space: pre;
      font-size: 0.875rem;
      color: #374151;
      line-height: 1.5;
      margin-top: 30px;
    }

    /* Стиль для обязательных полей */
    .required-field:after {
      content: "*";
      color: red;
      margin-left: 4px;
    }
    a{
      text-decoration: none;
      color: black;
    }
    /* Дополнительные стили для улучшения внешнего вида */
    .input-group:last-child {
      margin-bottom: 0;
    }


      /* Добавляем отступы между инпутами */
    .input-group > label {
      margin-bottom: 10px; /* Adds spacing between labels and inputs */
      font-size: 22px;
    }
    .input-group::marker{
      color: var(--light-blue);
      font-size: 30px;
    }
    label.required-field::after{
      display: none;
    }
    #projectNameInput::placeholder{
      color: var(--blue);
    }

  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- <div class="top">
    <h1>Загрузить услугу</h1>
  </div> -->

    <div class="elems">
        <article class="active-article">
            <img width="45px" src="Rocket_Selected.png" alt="">
                        <p>&nbsp;&nbsp;Создать услугу</p>
        </article>
        <article  class="inactive-article">
            <img width="32px" src="Folder_Unselected.png" alt="">
                        <a href="project.html">&nbsp;&nbsp;&nbsp;&nbsp;Мои проекты</a>
        </article>
        <article class="inactive-article">
            <img width="40px" src="View_Unselected.png" alt="">
                        <p>&nbsp;&nbsp;&nbsp;Инструкции</p>
        </article>
    </div>
  <div class="container">
    <h1>Прикрепите файлы</h1>
        <div class="input-group">
      <label for="projectNameInput" class="required-field">Название проекта:</label>
      <input type="text" id="projectNameInput" placeholder="Назовите шаблон" />
    </div>
    <ul>


    <li class="input-group">
        <label for="jsonSchemaInput" class="required-field">JSON-схема услуги</label>
      <label for="jsonSchemaInput" class="custom-file-upload" id="json1">Загрузить файл</label>
      <input type="file" id="jsonSchemaInput" accept=".json" />
    </li>

    <li class="input-group">
      <label for="xsdSchemaInput" class="required-field">XSD-схема вида сведений</label>
      <label for="xsdSchemaInput" class="custom-file-upload" id="xsd1">Загрузить файл</label>
      <input type="file" id="xsdSchemaInput" accept=".xsd" />
    <li class="input-group">
      <label for="testJsonsInput" class="required-field">Один или несколько JSON-файлов тестовых заявлений (необязательно):</label>
      <label for="testJsonsInput" class="custom-file-upload" id="json2">Загрузить файлы</label>
      <input type="file" id="testJsonsInput" accept=".json" multiple />
    </li>
    </ul>
    <button id="generateBtn" disabled>Создать</button>
      <pre id="vmCodeDisplay"></pre>
      <button id="saveBtn" style="display:none;">Сохранить шаблон</button>
  <script>
    const projectNameInput = document.getElementById('projectNameInput');
    const jsonSchemaInput = document.getElementById('jsonSchemaInput');
    const xsdSchemaInput = document.getElementById('xsdSchemaInput');
    const testJsonsInput = document.getElementById('testJsonsInput');
    const generateBtn = document.getElementById('generateBtn');
    const vmCodeDisplay = document.getElementById('vmCodeDisplay');
    const saveBtn = document.getElementById('saveBtn');

    let projectName = '';
    let jsonSchema = null;
    let xsdSchema = null;
    let testJsons = [];

    function updateCanGenerate() {
      generateBtn.disabled = !(projectName && jsonSchema && xsdSchema);
    }

    projectNameInput.addEventListener('input', () => {
      projectName = projectNameInput.value.trim();
      updateCanGenerate();
    });

    jsonSchemaInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file) {
        const text = await file.text();
        try {
          jsonSchema = JSON.parse(text);
          jsonSchemaInput.style.borderColor = 'green';
        } catch (err) {
          alert('Ошибка парсинга JSON-схемы');
          jsonSchemaInput.style.borderColor = 'red';
          jsonSchema = null;
        }
      } else {
        jsonSchema = null;
      }
      updateCanGenerate();
    });

    xsdSchemaInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file) {
        xsdSchema = await file.text();
        xsdSchemaInput.style.borderColor = 'green';
      } else {
        xsdSchema = null;
      }
      updateCanGenerate();
    });

    testJsonsInput.addEventListener('change', async (e) => {
      testJsons = [];
      for (const file of e.target.files) {
        const text = await file.text();
        try {
          testJsons.push(JSON.parse(text));
        } catch (err) {
          console.warn(`Ошибка парсинга ${file.name}`);
        }
      }
    });

    // Фиксированные параметры (по умолчанию)
    const params = {
      prefix: "soc:",
      handleNullValues: "omit",
      dateFormat: "yyyy-MM-dd",
      transformFieldNames: "pascalCase",
      generateConditionals: true,
      listElementName: "Child",
      parseJsonStrings: true
    };

    generateBtn.addEventListener('click', async () => {
      if (!window.electronAPI) {
        alert("API не загружено");
        return;
      }

      const data = {
        projectName,
        jsonSchema,
        xsdSchema,
        testJsons
      };
      
      try {
        const vmCode = await window.electronAPI.createVMTemplate(null, data, params);
        vmCodeDisplay.textContent = vmCode;
        vmCodeDisplay.style.display="block";
        saveBtn.style.display = 'block';
        saveBtn.vmCode = vmCode;
      } catch (err) {
        alert("Ошибка генерации: " + err.message);
      }
    });
      saveBtn.addEventListener('click', async () => {
      if (!saveBtn.vmCode) return;

        try {
            const result = await window.electronAPI.saveFile(saveBtn.vmCode);
            if (result && result.success) {
                alert(`Файл успешно сохранён: ${result.filePath}`);
            } else if (result && result.canceled) {
                alert('Сохранение отменено'); 
            } else {
                alert('Ошибка при сохранении: ' + (result?.error || 'Неизвестная ошибка'));
            }
        } catch (error) {
            console.error("Error saving file:", error);
            alert("Ошибка при сохранении файла: " + error.message);
        }
    });
    updateCanGenerate();
  </script>
</body>
</html>